<!DOCTYPE html>
<html>
    <header>
        <title>Boozify</title>
        <link rel="icon" type="image/png" src="../static/images/favicon.ico">
        <link rel="stylesheet" href="../static/css/web.css">
    </header>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script >
        var seedString;

        var player;
        var start = 0;
        var end = start + 60;
      function onYouTubeIframeAPIReady() {
          console.log("youtube api installed");
      }

      var id_list = new Array();
      //id_list.push("smqNtBXN5Mc");
      //id_list.push("1KGCAffvGIw");
      //id_list.push("ZAxRozTgoXM");
      var song_num = 0;
      var event_trigger = 1;
      var first_played = false;
      var lastSong;
      function onPlayerStateChange(event) {

       if (event.data != YT.PlayerState.PLAYING && first_played){
            console.log("beer image");
        }
        console.log("player state: ", event.data);
        if (event.data == YT.PlayerState.PLAYING && first_played == false){
            first_played = true;
        }

        if (event.data == YT.PlayerState.ENDED){
            if (event_trigger == 0){
              event_trigger = 1;
              console.log("double fire");
              return;
            }
            else {
              console.log(id_list.length, " big boy");
              console.log("first fire");
              event_trigger = 0;
            }
            //if (player.videoId == lastSong){
              //console.log("we outtie");
              //console.log(lastSong);
              //player.destroy();
            //}
            if (song_num >= id_list.length) {
              //  console.log("end player");
                //console.log(song_num);
                song_num = 0;
                id_list = new Array();
                player.destroy();
            }
            //loads and plays next video
            //player.loadVideoById(id);
            console.log("player ended");
            player.loadVideoById({videoId:id_list[song_num], endSeconds:60});
            song_num += 1;
            console.log(song_num);
           
        }
      }
      function stopVideo() {
        player.stopVideo();
      }


        function SelectQueryType(clicked_id){
            document.getElementsByClassName("chooseOne")[0].innerHTML = clicked_id;
            document.getElementsByClassName("searchQuery")[0].disabled = false;
            seedString = clicked_id;
            if (clicked_id=="Genre") {
                var genres = ['acoustic', 'afrobeat', 'alt-rock', 'alternative', 'ambient', 'anime', 'black-metal', 'bluegrass', 'blues', 'bossanova', 'brazil', 'breakbeat', 'british', 'cantopop', 'chicago-house', 'children', 'chill', 'classical', 'club', 'comedy', 'country', 'dance', 'dancehall', 'death-metal', 'deep-house', 'detroit-techno', 'disco', 'disney', 'drum-and-bass', 'dub', 'dubstep', 'edm', 'electro', 'electronic', 'emo', 'folk', 'forro', 'french', 'funk', 'garage', 'german', 'gospel', 'goth', 'grindcore', 'groove', 'grunge', 'guitar', 'happy', 'hard-rock', 'hardcore', 'hardstyle', 'heavy-metal', 'hip-hop', 'holidays', 'honky-tonk', 'house', 'idm', 'indian', 'indie', 'indie-pop', 'industrial', 'iranian', 'j-dance', 'j-idol', 'j-pop', 'j-rock', 'jazz', 'k-pop', 'kids', 'latin', 'latino', 'malay', 'mandopop', 'metal', 'metal-misc', 'metalcore', 'minimal-techno', 'movies', 'mpb', 'new-age', 'new-release', 'opera', 'pagode', 'party', 'philippines-opm', 'piano', 'pop', 'pop-film', 'post-dubstep', 'power-pop', 'progressive-house', 'psych-rock', 'punk', 'punk-rock', 'r-n-b', 'rainy-day', 'reggae', 'reggaeton', 'road-trip', 'rock', 'rock-n-roll', 'rockabilly', 'romance', 'sad', 'salsa', 'samba', 'sertanejo', 'show-tunes', 'singer-songwriter', 'ska', 'sleep', 'songwriter', 'soul', 'soundtracks', 'spanish', 'study', 'summer', 'swedish', 'synth-pop', 'tango', 'techno', 'trance', 'trip-hop', 'turkish', 'work-out', 'world-music'];
                autocomplete(document.getElementById("search"), genres, true);
            } else {
                autocomplete(document.getElementById("search"), genres, false);
            }
        }

        function autocomplete(inp, arr, isGenre) {
          var currentFocus;
          var _listener = function(e) {
              var a, b, i, val = this.value;
              // close any already open lists of autocompleted values
              closeAllLists();
              if (!val) { return false;}
              currentFocus = -1;
              // create a DIV element that will contain the items (values):
              a = document.createElement("DIV");
              a.setAttribute("id", this.id + "autocomplete-list");
              a.setAttribute("class", "autocomplete-items");
              // append the DIV element as a child of the autocomplete container:
              this.parentNode.appendChild(a);
              for (i = 0; i < arr.length; i++) {
                // check if the item starts with the same letters as the text field value:
                if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                  // create a DIV element for each matching element:
                  b = document.createElement("DIV");
                  // make the matching letters bold:
                  b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                  b.innerHTML += arr[i].substr(val.length);
                  // insert a input field that will hold the current array item's value:
                  b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                  // execute a function when someone clicks on the item value (DIV element):
                  b.addEventListener("click", function(e) {
                      // insert the value for the autocomplete text field:*/
                      inp.value = this.getElementsByTagName("input")[0].value;
                      // close the list of autocompleted values
                      closeAllLists();
                  });
                  a.appendChild(b);
                }
              }
          }

          if (!isGenre) {
              inp.removeEventListener("input", _listener);
          } else {
              inp.addEventListener("input", _listener);
              /*execute a function presses a key on the keyboard:*/
              inp.addEventListener("keydown", function(e) {
                  var x = document.getElementById(this.id + "autocomplete-list");
                  if (x) x = x.getElementsByTagName("div");
                  if (e.keyCode == 40) {
                    /*If the arrow DOWN key is pressed,
                    increase the currentFocus variable:*/
                    currentFocus++;
                    /*and and make the current item more visible:*/
                    addActive(x);
                  } else if (e.keyCode == 38) { //up
                    /*If the arrow UP key is pressed,
                    decrease the currentFocus variable:*/
                    currentFocus--;
                    /*and and make the current item more visible:*/
                    addActive(x);
                  } else if (e.keyCode == 13) {
                    /*If the ENTER key is pressed, prevent the form from being submitted,*/
                    e.preventDefault();
                    if (currentFocus > -1) {
                      /*and simulate a click on the "active" item:*/
                      if (x) x[currentFocus].click();
                    }
                  }
              });
              function addActive(x) {
                /*a function to classify an item as "active":*/
                if (!x) return false;
                /*start by removing the "active" class on all items:*/
                removeActive(x);
                if (currentFocus >= x.length) currentFocus = 0;
                if (currentFocus < 0) currentFocus = (x.length - 1);
                /*add class "autocomplete-active":*/
                x[currentFocus].classList.add("autocomplete-active");
              }
              function removeActive(x) {
                /*a function to remove the "active" class from all autocomplete items:*/
                for (var i = 0; i < x.length; i++) {
                  x[i].classList.remove("autocomplete-active");
                }
              }
              function closeAllLists(elmnt) {
                /*close all autocomplete lists in the document,
                except the one passed as an argument:*/
                var x = document.getElementsByClassName("autocomplete-items");
                for (var i = 0; i < x.length; i++) {
                  if (elmnt != x[i] && elmnt != inp) {
                    x[i].parentNode.removeChild(x[i]);
                  }
                }
              }
              /*execute a function when someone clicks in the document:*/
              document.addEventListener("click", function (e) {
                  closeAllLists(e.target);
              });
            }
        }

        function SearchInput(){
            document.getElementById("power_hour").disabled = false;
        }
        
        function MakePowerHour() {
            
            fetch("/get-link", {
                method: "POST",
                headers: new Headers({
                    "content-type": "application/json"
                }),
                body: JSON.stringify({
                    "seed": seedString,
                    "search": document.getElementById('search').value,
                })
            })
            .then(function(response) {
                console.log(response);
                response.json().then( data => {//function(data) {
                    console.log(data);
                    for (song_id  of data.ids) {
                        console.log(song_id);
                        id_list.push(song_id);
                    }                
                    if (id_list.length > 0) {
                        lastSong = id_list[id_list.length - 1];
                        console.log(lastSong);
                        
                        player = new YT.Player('player', {
                            height: '100%',
                            width: '100%',
                            videoId: id_list[0],
                            // videoId: 'M7lc1UVf-VE',
                            playerVars: {
                                start: start,
                                end: end,
                                controls: 0,
                                disablekb: 1,
                                fs: 1
                            },
                            events: {
                                //'onReady': onPlayerReady,
                                'onStateChange': onPlayerStateChange
                            }
                        });
                        song_num += 1;
                        //player.cueVideoById({videoId:id_list[song_num], endSeconds:60, "medium"});
                        
                        //document.getElementById("player").style.display = "flex";
                       // document.getElementById("deactivate").disabled = false;
                    }
                    //document.getElementById("player").src = data['link'];
                });
            })
            .catch(console.error);
            //if id_list is not empty then load the youtube player
            
        }
        function DestroyPowerHour() {
           // document.getElementById("deactivate").disabled = true;
            player.destroy();
            id_list = new Array();
            song_num = 0;
        }

    </script>

    <body style="background-color:darkslategrey">
        <div class="logo">
            <img class="boozify_logo" src="/static/images/logo2.png" width="400">
        </div>
        <div class="search">
            <div class="dropdown">
                <button class="chooseOne"> Select one &#9660;</button>
                <div class="options">
                    <a id="Artist" href="#" onclick="SelectQueryType(this.id)">Artist</a>
                    <a id="Genre" href="#" onclick="SelectQueryType(this.id)">Genre</a>
                    <a id="Playlist" href="#" onclick="SelectQueryType(this.id)">Playlist</a>
                </div>
            </div>
            <div class="searchbar">
                <form autocomplete="off">
                    <div class="autocomplete">
                        <input class="searchQuery" type="text" id="search" placeholder="Search with artist name, genre, or Spotify playlist link" disabled oninput="SearchInput()">
                    </div>
                </form>
            </div>
        </div>
        <div class="activate">
                <button id="power_hour" disabled onclick="MakePowerHour()">Make me a Power Hour!</button>
        </div>
        <div class="video">
            
            <div id="player"></div>

        </div>
        
       

        <script>
            /*
            <img class="beer" src="/static/images/beer.jpg" disabled>
             <div class="deactivate">
            <button id="end_power_hour" disabled onclick="DestroyPowerHour()">Destroy Power Hour/retry power hour</button>
        </div>
            <div class="video">
                <iframe 
                    id="player"
                    src="" frameborder="0" gesture="media"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen>
                </iframe>
            </div>
            */
        </script>
    </body>
</html>
